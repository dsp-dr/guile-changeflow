### Production Validation Tests for Guile ChangeFlow
### Run with REST Client extension in VS Code or similar tool
### Base URL: https://api.changeflow.us

@baseUrl = https://api.changeflow.us
@contentType = application/json

### 1. Health Check - Should return healthy status
GET {{baseUrl}}/
Accept: {{contentType}}

### Expected Response:
# {
#   "status": "healthy",
#   "message": "MCP Server Ready",
#   "version": "2024-11-05"
# }

###

### 2. MCP Initialize - Protocol handshake
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {
      "name": "production-validator",
      "version": "1.0.0"
    }
  },
  "id": 1
}

### Expected: serverInfo with name and version

###

### 3. List Tools - Should return exactly 8 ITIL tools
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/list",
  "id": 2
}

### Expected: 8 tools including create_change_request, assess_change_risk, etc.

###

### 4. Create Standard Change Request
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "create_change_request",
    "arguments": {
      "title": "Production Validation Test",
      "description": "Automated test change request",
      "risk_level": "low",
      "environment": "production"
    }
  },
  "id": 3
}

### Expected: change_id starting with CHG-, status: pending

###

### 5. Assess Change Risk - Medium risk scenario
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "assess_change_risk",
    "arguments": {
      "change_type": "deployment",
      "environment": "production",
      "components_affected": 3,
      "has_rollback": true,
      "tested_in_staging": true
    }
  },
  "id": 4
}

### Expected: risk_score 30-70, risk_level: medium

###

### 6. Check Freeze Period - Current date
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "check_freeze_period",
    "arguments": {
      "planned_start": "2025-09-15T10:00:00Z",
      "planned_end": "2025-09-15T12:00:00Z",
      "environment": "production"
    }
  },
  "id": 5
}

### Expected: is_freeze_period: false (unless in December)

###

### 7. Get CAB Members for High Risk
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "get_cab_members",
    "arguments": {
      "risk_level": "high",
      "environment": "production"
    }
  },
  "id": 6
}

### Expected: Array of CAB members with roles

###

### 8. Schedule Change
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "schedule_change",
    "arguments": {
      "change_id": "CHG-TEST-001",
      "scheduled_start": "2025-09-20T02:00:00Z",
      "scheduled_end": "2025-09-20T04:00:00Z",
      "notification_contacts": ["ops@company.com"]
    }
  },
  "id": 7
}

### Expected: confirmation with scheduled details

###

### 9. Create Emergency Change
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "create_emergency_change",
    "arguments": {
      "title": "Critical Security Patch",
      "description": "Emergency patch for CVE-2025-TEST",
      "justification": "Active exploitation detected",
      "impact": "Service restart required",
      "environment": "production",
      "requester": "security-team@company.com"
    }
  },
  "id": 8
}

### Expected: change_id starting with EMG-, status: pending_emergency_approval

###

### 10. Get Change Metrics - Monthly
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "get_change_metrics",
    "arguments": {
      "time_period": "month",
      "environment": "production",
      "metric_type": "all"
    }
  },
  "id": 9
}

### Expected: Metrics including success_rate, rollback_rate

###

### 11. Generate Audit Report
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "generate_audit_report",
    "arguments": {
      "report_type": "compliance",
      "date_range": {
        "start": "2025-09-01",
        "end": "2025-09-14"
      },
      "include_details": true
    }
  },
  "id": 10
}

### Expected: Compliance report with ITIL adherence metrics

###

### 12. Performance Test - Rapid succession
POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/list",
  "id": 100
}

###

POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/list",
  "id": 101
}

###

POST {{baseUrl}}/
Content-Type: {{contentType}}

{
  "jsonrpc": "2.0",
  "method": "tools/list",
  "id": 102
}

### Expected: All responses < 200ms